trigger:
  branches:
    include:
      - feature/*
      - master
  paths:
    include:
      - auth-api/**

pool:
  vmImage: ubuntu-latest

variables:
  service_dir: 'auth-api'
  vm_ip: '172.172.175.246'
  remote_base_dir: '~/microservice-app-example'
  remote_service_dir: '~/microservice-app-example/auth-api'

stages:
- stage: BuildAndDeploy
  jobs:
  - job: BuildAuthApi
    displayName: 'Build y Deploy de Auth API'
    steps:
      - checkout: self

      - task: CopyFilesOverSSH@0
        inputs:
          sshEndpoint: VM-DEV-CONNECTION
          sourceFolder: $(service_dir)
          contents: '**'
          targetFolder: $(remote_service_dir)
        displayName: 'Copiar carpeta actualizada a la VM'

      - task: SSH@0
        inputs:
          sshEndpoint: VM-DEV-CONNECTION
          runOptions: inline
          inline: |
            echo "Reconstruyendo y levantando auth-api vía Docker Compose"
            cd $(remote_base_dir)
            
            docker-compose build auth-api 2>&1 | sed 's/##\[error\]/\[error\]/g'
            BUILD_STATUS=${PIPESTATUS[0]}
            if [ $BUILD_STATUS -ne 0 ]; then
              echo "Error en la construcción del auth-api."
              exit 1
            fi

            echo "Levantando contenedor auth-api..."
            docker-compose up -d auth-api || true
        displayName: 'Reconstruir y levantar contenedor auth-api'
